name: Sync Google Sheet to JSON (push main)

on:
  schedule:
    - cron: "0 * * * *"   # every hour
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      # ✅ 用 export CSV，唔好用 /edit URL
      SHEET_URL: "https://docs.google.com/spreadsheets/d/1kHUqAVX7t_HJ4RbKsvbAryeFc3d9XWj_Zw7iU8h4Jfw/export?format=csv&gid=87935078"
      OUT_JSON: "services.json"

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pandas

      - name: Fetch Google Sheet CSV
        run: |
          set -e
          echo "→ Download: $SHEET_URL"
          CODE=$(curl -sSL -w "%{http_code}" -o sheet.csv "$SHEET_URL")
          echo "HTTP_STATUS=$CODE"
          if [ "$CODE" -ne 200 ]; then
            echo "Download failed ($CODE) — first 500 bytes:" >&2
            head -c 500 sheet.csv >&2 || true
            exit 1
          fi
          echo "---- head (first 2 lines) ----"
          head -n 2 sheet.csv || true

      - name: Convert CSV to JSON
        run: |
          python - <<'PY'
          import json
          import pandas as pd

          df = pd.read_csv("sheet.csv", dtype=str, keep_default_na=False, encoding="utf-8")

          # 你而家 services sheet header（你貼過嗰套）
          expected = [
            "itemId","nameZh","nameEn","categoryId","states","phone","website","actionType",
            "descZh","descEn","rank","enabled","hoursZh","hoursEn"
          ]

          # 嚴格模式：缺欄就直接 fail，避免生成怪檔
          missing = [c for c in expected if c not in df.columns]
          if missing:
            raise SystemExit(f"Missing columns in sheet: {missing}. Got columns: {list(df.columns)}")

          df = df[expected].copy()

          # normalize boolean/rank
          def norm_enabled(v):
            s = (v or "").strip().lower()
            return s in ("true","1","yes","y","是","有")

          def norm_rank(v):
            s = (v or "").strip()
            try:
              return int(float(s)) if s else None
            except:
              return None

          out = []
          for _, r in df.iterrows():
            item = {k: (r[k].strip() if isinstance(r[k], str) else r[k]) for k in expected}

            item["enabled"] = norm_enabled(item.get("enabled"))
            item["rank"] = norm_rank(item.get("rank"))

            # states 保留你原本格式（CSV 係 "NSW, VIC, ..."）
            # 如你想 App 直接用 array，可以喺呢度 split
            # item["states"] = [x.strip() for x in (item["states"] or "").split(",") if x.strip()]

            out.append(item)

          with open("services.json", "w", encoding="utf-8") as f:
            json.dump(out, f, ensure_ascii=False, indent=2)

          print("Wrote services.json items =", len(out))
          PY

      - name: Commit & push to main (only if changed)
        run: |
          set -e
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # 只 add 你輸出檔（避免亂 commit）
          git add services.json

          # 如果冇變更，就退出
          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          git commit -m "chore: sync services.json from Google Sheet"
          git push origin main
