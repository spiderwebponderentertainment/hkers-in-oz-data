name: Sync Google Sheet to JSON (push main)

on:
  schedule:
    - cron: "0 * * * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      SHEET_CSV_URL: "https://docs.google.com/spreadsheets/d/1kHUqAVX7t_HJ4RbKsvbAryeFc3d9XWj_Zw7iU8h4Jfw/export?format=csv&gid=87935078"
      OUT_JSON: "services.json"

    steps:
      - name: Checkout repo (main)
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pandas

      - name: Fetch Google Sheet CSV
        run: |
          set -e
          CODE=$(curl -sSL -w "%{http_code}" -o sheet.csv "$SHEET_CSV_URL")
          if [ "$CODE" -ne 200 ]; then
            echo "Download failed ($CODE)" >&2
            head -c 500 sheet.csv >&2 || true
            exit 1
          fi
          wc -l sheet.csv || true
          head -n 2 sheet.csv || true

      - name: Convert CSV to JSON (for App)
        run: |
          python - <<'PY'
          import pandas as pd, json, sys

          df = pd.read_csv("sheet.csv", dtype=str, keep_default_na=False, encoding="utf-8")

          df.columns = [c.replace("\u00A0", " ").strip() for c in df.columns]

          required = [
            "itemId","nameZh","nameEn","categoryId","states","phone","website","actionType",
            "descZh","descEn","rank","enabled","hoursZh","hoursEn"
          ]
          missing = [c for c in required if c not in df.columns]
          if missing:
            print("Missing columns:", missing, file=sys.stderr)
            sys.exit(1)

          def clean(v):
            s = str(v).replace("\u00A0"," ").strip()
            return s if s else None

          def split_states(v):
            s = clean(v)
            if not s: 
              return []
            s = s.replace("；",";").replace("，",",")
            for sp in ["|","/","、","／"]:
              s = s.replace(sp, ",")
            parts = []
            for chunk in s.split(","):
              chunk = chunk.strip()
              if chunk:
                parts.append(chunk.upper())
            return parts

          out = []
          for _, r in df.iterrows():
            if not (clean(r["nameZh"]) or clean(r["nameEn"])):
              continue

            rank_raw = clean(r["rank"])
            try:
              rank_val = int(rank_raw) if rank_raw is not None else None
            except Exception:
              rank_val = None

            enabled_raw = (clean(r["enabled"]) or "").lower()
            enabled_val = enabled_raw in ("1","true","yes","y")

            item = {
              "itemId": clean(r["itemId"]),
              "nameZh": clean(r["nameZh"]),
              "nameEn": clean(r["nameEn"]),
              "categoryId": clean(r["categoryId"]),
              "states": split_states(r["states"]),
              "phone": clean(r["phone"]),
              "website": clean(r["website"]),
              "actionType": clean(r["actionType"]),
              "descZh": clean(r["descZh"]),
              "descEn": clean(r["descEn"]),
              "rank": rank_val,
              "enabled": enabled_val,
              "hoursZh": clean(r["hoursZh"]),
              "hoursEn": clean(r["hoursEn"]),
            }
            out.append(item)

          with open("services.json","w",encoding="utf-8") as f:
            json.dump(out, f, ensure_ascii=False, indent=2)

          print("Wrote services.json items =", len(out))
          PY

      - name: Commit & push to main (only if changed)
        run: |
          set -e
          if git diff --quiet -- services.json; then
            echo "No changes in services.json. Skip commit."
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add services.json
          git commit -m "chore: sync services.json from Google Sheet"
          git push origin HEAD:main
