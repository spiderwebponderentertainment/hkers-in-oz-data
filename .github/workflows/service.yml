name: Sync Google Sheet to TSV

on:
  schedule:
    - cron: "0 * * * *"
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      SHEET_URL: "https://docs.google.com/spreadsheets/d/1kHUqAVX7t_HJ4RbKsvbAryeFc3d9XWj_Zw7iU8h4Jfw/edit?gid=87935078#gid=87935078"
      OUT_TSV: "services.tsv"

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pandas

      - name: Fetch Google Sheet CSV
        run: |
          set -e
          echo "→ Try: $SHEET_URL"
          CODE=$(curl -sSL -w "%{http_code}" -o sheet.csv "$SHEET_URL")
          echo "HTTP_STATUS=$CODE"
          if [ "$CODE" -ne 200 ]; then
            echo "Download failed ($CODE) — first 500 bytes of response:" >&2
            head -c 500 sheet.csv >&2 || true
            exit 1
          fi
          wc -l sheet.csv || true
          echo "---- head ----"; head -n 2 sheet.csv || true

      - name: Convert CSV to TSV (preserve column order)
        run: |
          python - <<'PY'
          import pandas as pd

          df = pd.read_csv('sheet.csv', dtype=str, keep_default_na=False, encoding='utf-8')

          # 如果你想「固定欄位順序」，就喺呢度寫死欄位名（同你 sheet header 一致）
          expected = [
            "itemId","nameZh","nameEn","categoryId","states","phone","website","actionType",
            "descZh","descEn","rank","enabled","hoursZh","hoursEn"
          ]
          # 只取存在嘅欄位，避免報錯；亦可以改成嚴格模式：缺欄就 exit 1
          cols = [c for c in expected if c in df.columns]
          df = df[cols]

          # 輸出 TSV
          out = "services.tsv"
          df.to_csv(out, sep="\t", index=False, encoding="utf-8")
          print("Wrote", out, "rows=", len(df), "cols=", len(df.columns))
          PY

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "chore: sync services.tsv from Google Sheet"
          title: "chore: sync services.tsv from Google Sheet"
          body: |
            Auto-generated by workflow.
            - Source: Google Sheet (published CSV)
            - Output: `services.tsv`
          branch: automation/sheet-sync
          token: ${{ secrets.GITHUB_TOKEN }}
          delete-branch: true
          add-paths: |
            services.tsv
