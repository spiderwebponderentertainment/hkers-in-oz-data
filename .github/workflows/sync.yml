name: Sync Google Sheet to JSON

on:
  schedule:
    - cron: "0 * * * *"        # æ¯å°æ™‚
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      # ðŸ‘‰ æ›æˆä½  Google Sheetã€Œç™¼ä½ˆç‚º CSVã€å˜… URLï¼ˆæ³¨æ„ gidï¼‰
      SHEET_URL: "https://docs.google.com/spreadsheets/d/e/REPLACE_ME/pub?gid=0&single=true&output=csv"

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pandas

      - name: Fetch Google Sheet CSV
        run: |
          set -e
          CODE=$(curl -sSL -w "%{http_code}" -o sheet.csv "$SHEET_URL")
          echo "HTTP_STATUS=$CODE"
          if [ "$CODE" -ne 200 ]; then
            echo "Download failed ($CODE)" >&2
            exit 1
          fi
          echo "==== sheet.csv meta ===="
          wc -l sheet.csv || true
          echo "---- head ----"; head -n 5 sheet.csv || true

      - name: Convert CSV to JSON (new schema with zh/en names & tags)
        run: |
          python - <<'PY'
          import pandas as pd, json, re, sys

          def norm_str(v):
              if v is None: return None
              s = str(v).strip()
              return s if s else None

          def split_list(v):
              s = norm_str(v)
              if not s: return []
              s = s.replace('ï¼›',';').replace('ï¼Œ',',')
              for sp in ['|',';','/','ã€','ï¼']:
                  s = s.replace(sp, ',')
              return [p.strip() for p in s.split(',') if p.strip()]

          def norm_states(v):
              return [x.upper() for x in split_list(v)]

          def norm_url(v):
              s = norm_str(v)
              if not s: return None
              if not re.match(r'^[a-zA-Z]+://', s):
                  s = 'https://' + s
              return s

          def to_float(x):
              try:
                  return float(x) if x is not None and str(x).strip() != '' else None
              except Exception:
                  return None

          try:
              df = pd.read_csv('sheet.csv', dtype=str, keep_default_na=False)
          except Exception as e:
              print('CSV read error:', e); sys.exit(1)

          out = []
          for _, r in df.iterrows():
              # èˆŠ nameï¼ˆä¿ç•™ï¼‰
              name_legacy = norm_str(r.get('name'))

              # æ–°ï¼šä¸­è‹±åï¼ˆæŽ¥å— nameZh/name_zhã€nameEn/name_enï¼‰
              nameZh = norm_str(r.get('nameZh')) or norm_str(r.get('name_zh'))
              nameEn = norm_str(r.get('nameEn')) or norm_str(r.get('name_en'))

              # è‹¥åªæœ‰ä¸­æ–‡è€Œä¸­æ–‡å…§å« (English) â†’ æ‹†å‡ºä¾†ï¼ˆåŒ App å´é‚Š hotfix ä¸€è‡´ï¼‰
              if (not nameEn) and nameZh:
                  m = re.match(r'^\s*(.+?)\s*[\(ï¼ˆ]\s*([A-Za-z0-9 .,\'+&/-]+)\s*[\)ï¼‰]\s*$', nameZh)
                  if m:
                      nameZh = m.group(1).strip()
                      nameEn = m.group(2).strip()

              # ç„¡åå°± skip
              if not (name_legacy or nameZh or nameEn):
                  continue

              item = {
                  # å…¼å®¹èˆŠ Appï¼šname ç¹¼çºŒå­˜åœ¨ï¼ˆç›¡é‡ç”¨è‹±æ–‡ï¼Œfallback ä¸­æ–‡ï¼èˆŠï¼‰
                  'name'      : name_legacy or (nameEn or nameZh or ''),
                  # æ–°æ¬„ä½
                  'nameZh'    : nameZh,
                  'nameEn'    : nameEn,

                  'category'  : norm_str(r.get('category')) or 'uncategorized',

                  # tagsï¼šæ–°ä¸­è‹± + èˆŠ
                  'tags'      : split_list(r.get('tags')),                                   # èˆŠ
                  'tagsZh'    : split_list(r.get('tagsZh') or r.get('tags_zh')),
                  'tagsEn'    : split_list(r.get('tagsEn') or r.get('tags_en') or r.get('tags')),

                  # åœ°åŸŸ
                  'suburb'    : norm_str(r.get('suburb')) or norm_str(r.get('area')),        # area â†’ suburb
                  'area'      : norm_str(r.get('area')),                                     # ä¿ç•™èˆŠ key ä½œå…¼å®¹
                  'address'   : norm_str(r.get('address')),

                  'email'     : norm_str(r.get('email')),
                  'phone'     : norm_str(r.get('phone')),
                  'website'   : norm_url(r.get('website')),

                  # é€£éŽ–
                  'chainId'   : norm_str(r.get('chainId') or r.get('chain_id')),
                  'branchName': norm_str(r.get('branchName') or r.get('branch_name')),
              }

              # states / cities å…¼å®¹
              states = norm_states(r.get('states') or r.get('state'))
              item['states'] = states if states else []

              cities = split_list(r.get('cities') or r.get('city'))
              if cities: item['cities'] = cities

              # lat/lng
              lat = norm_str(r.get('lat')); lng = norm_str(r.get('lng'))
              if lat is not None or lng is not None:
                  item['lat'] = to_float(lat)
                  item['lng'] = to_float(lng)

              # sponsor / ads
              isSponsored = norm_str(r.get('isSponsored') or r.get('is_sponsored'))
              if isSponsored is not None:
                  item['isSponsored'] = isSponsored.lower() in ('1','true','yes','y')
              for k in ['sponsorTier','sponsorStart','sponsorEnd','adLink','adNote']:
                  v = norm_str(r.get(k) or r.get(k.lower()))
                  if k == 'adLink':
                      v = norm_url(v)
                  if v: item[k] = v

              out.append(item)

          with open('businesses.json','w',encoding='utf-8') as f:
              json.dump(out, f, ensure_ascii=False, indent=2, sort_keys=True)

          print('Wrote businesses.json with', len(out), 'items')
          PY

      - name: Show diff
        run: |
          echo "==== git status ===="
          git status --porcelain
          echo "==== diff (businesses.json) ===="
          git --no-pager diff -- businesses.json || true

      - name: Create Pull Request
        id: cpr
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "chore: sync businesses.json from Google Sheet"
          title: "chore: sync businesses.json from Google Sheet"
          body: |
            Auto-generated by **Sync Google Sheet to JSON** workflow.
            - Source: Google Sheet (published CSV)
            - Output: `businesses.json`
          branch: automation/sheet-sync
          token: ${{ secrets.GITHUB_TOKEN }}
          delete-branch: true
          add-paths: |
            businesses.json

      # âœ… å•Ÿç”¨ auto-mergeï¼ˆç”¨é»žè™Ÿæˆ–å–®å¼•è™Ÿå– output keyï¼‰
      - name: Enable auto-merge on PR
        if: ${{ steps.cpr.outputs.pull-request-number }}
        uses: peter-evans/enable-pull-request-automerge@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          pull-request-number: ${{ steps.cpr.outputs.pull-request-number }}
          merge-method: squash

      # âœ… ç«‹å³å˜—è©¦åˆä½µï¼ˆå¯èƒ½æœƒè¢«ä¿è­·åˆ†æ”¯é˜»æ“‹ï¼‰ï¼›ç”¨ env å¸¶ PR è™Ÿ
      - name: Merge PR via API (best effort)
        if: ${{ steps.cpr.outputs.pull-request-number }}
        uses: actions/github-script@v7
        env:
          PR_NUMBER: ${{ steps.cpr.outputs.pull-request-number }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const pr = Number(process.env.PR_NUMBER || '0');
            if (!pr) {
              core.info('No PR number; skip merge.');
              return;
            }
            try {
              const { data } = await github.rest.pulls.merge({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: pr,
                merge_method: 'squash'
              });
              core.info(`Merged PR #${pr}: ${data.sha}`);
            } catch (e) {
              core.warning(`Merge failed (maybe branch protection requires review). ${e.message}`);
            }
