name: Sync Google Sheet to JSON

on:
  schedule:
    - cron: "0 * * * *"           # æ¯å°æ™‚åŸ·è¡Œä¸€æ¬¡
  workflow_dispatch:               # å…è¨±æ‰‹å‹•è§¸ç™¼

permissions:
  contents: write                  # éœ€è¦é–‹ PR
  pull-requests: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pandas

      - name: Fetch Google Sheet CSV
        run: |
          set -e
          # ðŸ‘‰ æ›æˆä½  Google Sheetã€Œç™¼ä½ˆç‚º CSVã€çš„é€£çµ
          URL="https://docs.google.com/spreadsheets/d/e/2PACX-1vSpt865HzuchDUxgZIPL3RBbZ-VneXtRFgM0Gt0fDAla2yk_Afh4t5iw-6a2U0lmqSiiQagcSE6Rjk9/pub?gid=0&single=true&output=csv"
          CODE=$(curl -sSL -w "%{http_code}" -o sheet.csv "$URL")
          echo "HTTP_STATUS=$CODE"
          if [ "$CODE" -ne 200 ]; then
            echo "Download failed ($CODE)" >&2
            exit 1
          fi
          echo "==== sheet.csv meta ===="
          wc -l sheet.csv || true
          echo "---- head ----"; head -n 5 sheet.csv || true

      - name: Convert CSV to JSON
        run: |
          python - <<'PY'
          import pandas as pd, json, re, sys

          # 1) å…¨æ¬„ä½æŒ‰å­—ä¸²è®€ï¼Œé¿å…é›»è©±/éƒµéžå€è™Ÿè¢«è½‰ç‚ºæ•¸å­—
          try:
              df = pd.read_csv('sheet.csv', dtype=str, keep_default_na=False)
          except Exception as e:
              print('CSV read error:', e)
              sys.exit(1)
          print(f'Rows loaded: {len(df)}')

          def norm_str(v):
              if v is None: return None
              s = str(v).strip()
              return s if s else None

          def split_list(v):
              """ä»¥ , ; | / ã€ åˆ†éš”ï¼Œè¼¸å‡ºæ¸…æ½”å­—ä¸²é™£åˆ—"""
              s = norm_str(v)
              if not s: return []
              s = s.replace('ï¼›',';').replace('ï¼Œ',',')
              for sp in ['|',';','/','ã€']:
                  s = s.replace(sp, ',')
              return [p.strip() for p in s.split(',') if p.strip()]

          def norm_states(v):
              return [x.upper() for x in split_list(v)]

          def norm_phone(v):
              """é›»è©±ä¿æŒåŽŸæ¨£ï¼ˆåªä¿®å‰ªé ­å°¾ç©ºç™½ï¼‰ï¼Œä¿ç•™ leading 0 / +61 ç­‰"""
              s = norm_str(v)
              return s

          def norm_website(v):
              s = norm_str(v)
              if not s: return None
              if not re.match(r'^[a-zA-Z]+://', s):
                  s = 'https://' + s
              return s

          def to_float(x):
              try:
                  return float(x) if x is not None else None
              except Exception:
                  return None

          out = []
          for _, r in df.iterrows():
              name = norm_str(r.get('name'))
              if not name:
                  continue  # ç„¡åç¨±çš„è¡Œè·³éŽ

              item = {
                  'name': name,
                  'category': norm_str(r.get('category')) or 'uncategorized',
                  'tags': split_list(r.get('tags')),
                  'area': norm_str(r.get('area')),
                  'address': norm_str(r.get('address')),
                  'email': norm_str(r.get('email')),
                  'phone': norm_phone(r.get('phone')),
                  'website': norm_website(r.get('website')),
              }

              # states / state
              states = norm_states(r.get('states'))
              state  = norm_str(r.get('state'))
              if states:
                  item['states'] = states
              elif state:
                  item['states'] = [state.upper()]
              else:
                  item['states'] = []

              # cities / city
              cities = split_list(r.get('cities'))
              city   = norm_str(r.get('city'))
              if cities:
                  item['cities'] = cities
              elif city:
                  item['cities'] = [city]

              # åº§æ¨™ï¼ˆå¦‚æœ‰ï¼‰
              lat = norm_str(r.get('lat')); lng = norm_str(r.get('lng'))
              if lat is not None or lng is not None:
                  item['lat'] = to_float(lat)
                  item['lng'] = to_float(lng)

              # å»£å‘Šç›¸é—œï¼ˆå¯é¸ï¼‰
              isSponsored = norm_str(r.get('isSponsored'))
              if isSponsored is not None:
                  item['isSponsored'] = isSponsored.lower() in ('1','true','yes','y')
              for k in ['sponsorTier','sponsorStart','sponsorEnd','adLink','adNote']:
                  v = norm_str(r.get(k))
                  if k == 'adLink':
                      v = norm_website(v)
                  if v is not None:
                      item[k] = v

              out.append(item)

          with open('businesses.json','w',encoding='utf-8') as f:
              json.dump(out, f, ensure_ascii=False, indent=2, sort_keys=True)
          print('Wrote businesses.json with', len(out), 'items')
          PY

      - name: Show diff
        run: |
          echo "==== git status ===="
          git status --porcelain
          echo "==== diff (businesses.json) ===="
          git --no-pager diff -- businesses.json || true

      - name: Create Pull Request
        id: cpr
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "chore: sync businesses.json from Google Sheet"
          title: "chore: sync businesses.json from Google Sheet"
          body: |
            Auto-generated by **Sync Google Sheet to JSON** workflow.
            - Source: Google Sheet (published CSV)
            - Output: `businesses.json`
          branch: automation/sheet-sync
          delete-branch: true

      - name: Show PR info (if created)
        if: ${{ steps.cpr.outputs.pull-request-number != '' }}
        run: |
          echo "PR #${{ steps.cpr.outputs.pull-request-number }}"
          echo "${{ steps.cpr.outputs.pull-request-url }}"

      - name: Enable auto-merge
        if: ${{ steps.cpr.outputs.pull-request-number != '' }}
        uses: peter-evans/enable-pull-request-automerge@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          pull-request-number: ${{ steps.cpr.outputs.pull-request-number }}
          merge-method: squash

      - name: Merge the PR (no pending checks)
        if: ${{ steps.cpr.outputs.pull-request-number != '' }}
        uses: peter-evans/merge-pull-request@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          pull-request-number: ${{ steps.cpr.outputs.pull-request-number }}
          merge-method: squash
